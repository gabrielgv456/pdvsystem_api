SELECT IDPREST, PRESTADORA, TIPO, ORDEM, TOTCUSTO, QTD,
    CAST (CASE WHEN TIPO = 2 THEN SUM(TOTCUSTO) ELSE 0 END AS DOUBLE PRECISION) TOTCUSTOGERAL,
    CAST (CASE WHEN TIPO = 2 THEN SUM(QTD) ELSE 0 END AS DOUBLE PRECISION) QTDGERAL
FROM
(
SELECT
   IDPREST,
   PRESTADORA,
   TIPO,
   ORDEM,
   SUM(CAST(TOTCUSTO AS NUMERIC(15,2))) TOTCUSTO,
   SUM(CAST(QTD AS INTEGER))QTD
FROM
(
   SELECT
      P.T210IDPREST IDPREST,
      '  • ' || P.T210NOME PRESTADORA,
      CAST ('01.01.2015' AS DATE) DATAREG,
      0 TOTCUSTO,
      0 QTD,
      0 ORDEM,
      0 TIPO
   FROM T210SPCPRESTADOR P

   UNION

   SELECT
      P.T210IDPREST IDPREST,
      '      - ' || S.T211DESCRICAO PRESTADORA,
      CAST(C.T214DATAHORA AS DATE) DATAREG,
      SUM(C.T214CUSTO) TOTCUSTO,
      CAST(COUNT(*) AS INTEGER) QTD,
      1 ORDEM,
      1 TIPO
   FROM T214SPCCONSULTAS C
   INNER JOIN T211SPCSERVICO S ON C.T214IDSERVICO = S.T211IDSERVICO
   INNER JOIN T210SPCPRESTADOR P ON S.T211IDPREST = P.T210IDPREST
   WHERE CHAR_LENGTH(C.T214PROTOCOLO) > 5
   GROUP BY 1,2,3

   UNION

   SELECT
      P.T210IDPREST IDPREST,
      '      - '||'Negativações' PRESTADORA,
      CAST(L.T218DATAHORARET AS DATE) DATAREG,
      SUM(N.T219CUSTOREG) TOTCUSTO,
      CAST(COUNT(*) AS INTEGER) QTD,
      2 ORDEM,
      1 TIPO
   FROM T218SPCLOTEMOV L
   INNER JOIN T219SPCLOTENEGITENS N ON L.T218IDLOTE = N.T219IDLOTE
   INNER JOIN T210SPCPRESTADOR P ON L.T218PRESTADORA = P.T210IDPREST
   WHERE L.T218TIPOMOV = 'I' AND N.T219CODRETORNO = 0 AND N.T219IDLOTE <> 1
   AND L.T218IDLOTE > 5
   GROUP BY 1,2,3

   UNION

   SELECT
         IDPREST,
         '  • ' ||'TOTAL' PRESTADORA,
         DATAREG,
         (TOTCUSTO),
         (QTD),
         1 ORDEM,
         2 TIPO
   FROM
   (
      SELECT
         P.T210IDPREST IDPREST,
         '  • ' || 'Total' PRESTADORA,
         CAST(C.T214DATAHORA AS DATE) DATAREG,
         SUM(C.T214CUSTO) TOTCUSTO,
         CAST(COUNT(*) AS INTEGER) QTD,
         1 ORDEM,
         2 TIPO
      FROM T214SPCCONSULTAS C
      INNER JOIN T211SPCSERVICO S ON C.T214IDSERVICO = S.T211IDSERVICO
      INNER JOIN T210SPCPRESTADOR P ON S.T211IDPREST = P.T210IDPREST
      WHERE CHAR_LENGTH(C.T214PROTOCOLO) > 5
      GROUP BY 1,2,3
   
   UNION
   
      SELECT
         P.T210IDPREST IDPREST,
         'Negativações' PRESTADORA,
         CAST(L.T218DATAHORARET AS DATE) DATAREG,
         SUM(N.T219CUSTOREG) TOTCUSTO1,
         CAST(COUNT(*) AS INTEGER) QTD,
         2 ORDEM,
         1 TIPO
      FROM T218SPCLOTEMOV L
      INNER JOIN T219SPCLOTENEGITENS N ON L.T218IDLOTE = N.T219IDLOTE
      INNER JOIN T210SPCPRESTADOR P ON L.T218PRESTADORA = P.T210IDPREST
      WHERE L.T218TIPOMOV = 'I' AND N.T219CODRETORNO = 0 AND N.T219IDLOTE <> 1
      AND L.T218IDLOTE > 5
      GROUP BY 1,2,3

   )

) WHERE (DATAREG BETWEEN :INICIO AND :FIM) OR (TIPO = 0)

GROUP BY 1,2,3,4
ORDER BY IDPREST, TIPO, ORDEM)
GROUP BY 1,2,3,4,5,6




Select
TO_CHAR(L.competencia, 'DD/MM/YYYY') COMPETENCIA,
P.Codigo CODPROD, 

cast(
Sum(Case
When L.Natureza = 'D' Then I.ValorTotal - COALESCE(I.DESCONTOSVALOR,0) + COALESCE (I.ACRESCIMOSVALOR,0) + COALESCE (I.FRETE,0)
ELSE 0 --I.ValorTotal * (-1)
END
)
AS float) RECBRUTA

FROM Benner_Corp.Cm_Itens I
INNER JOIN Benner_Corp.Pd_Produtos P On I.Produto = P.Handle
INNER Join Benner_Corp.Ct_Lancamentos L On I.Handle = L.LancamentoFinanceiroItem
INNER Join Benner_Corp.Ct_Contas C On L.Conta = C.Handle

Where 1 = 1
--And L.Competencia = to_date('01/07/2022', 'DD/MM/YYYY')
And L.Competencia = to_date('01/'|| :Mes || '/' || :Ano, 'DD/MM/YYYY')
And L.Conta = 10917 AND C.EMPRESA = 100

Group By L.competencia, P.Codigo
Order by 1, 2






WITH CORTES AS (
   SELECT
         DISTINCT
         CASE WHEN ITT.T076IDTRANSF IS NULL THEN 'Venda' ELSE 'Transferência' END TIPOCORTE,
         COALESCE(ITT.T076IDTRANSF,ITV.T081IDVENDA) IDPEDIDO,
         UPE.T623IDPEDIDOITEM IDORIGEM,
         RTI.T622ID IDREMESSA
   FROM T623EDROTAITEM UPE
   INNER JOIN T622EDROTATRANSF RTI ON RTI.T622ID = UPE.T623IDREMESSA
   LEFT JOIN (
      SELECT DISTINCT ITE.T0641IDITVENDA, ITE.T0641ID, ITE.T0641IDVENDA FROM T0641ITENTREGA ITE
      INNER JOIN T064CARGA CAR ON CAR.T064IDCARGA = ITE.T0641IDCARGA
      INNER JOIN T065ROTAS ROT ON ROT.T065IDCARGA = CAR.T064IDCARGA
      WHERE ROT.T065IDTRANSGRUPO IN ( SELECT
      P.T623IDREMESSA IDREMESSA
      FROM T064CARGA C
      INNER JOIN T065ROTAS R ON R.T065IDCARGA = C.T064IDCARGA
      INNER JOIN T0641ITENTREGA I ON I.T0641IDCARGA = R.T065IDCARGA
      INNER JOIN T622EDROTATRANSF G ON G.T622ID = R.T065IDTRANSGRUPO
      INNER JOIN T623EDROTAITEM P ON P.T623IDPLATAFORMA = G.T622ID AND P.T623IDPEDIDOITEM = I.T0641IDITVENDA
      INNER JOIN T620EDROTA E ON E.T620ID = G.T622IDROTA
      WHERE I.T0641IDVENDA = :NUMPEDIDO)
   ) II ON II.T0641IDITVENDA = UPE.T623IDPEDIDOITEM
   LEFT JOIN T081ITENVENDA ITV ON ITV.T081IDITVENDA = UPE.T623IDPEDIDOITEM
   LEFT JOIN T076ITTRANSF ITT ON ITT.T076SEQ = UPE.T623IDPEDIDOITEM
   WHERE
      UPE.T623STATUS = 'C'
      AND  RTI.T622ID IN (
      SELECT
      P.T623IDREMESSA IDREMESSA
      FROM T064CARGA C
      INNER JOIN T065ROTAS R ON R.T065IDCARGA = C.T064IDCARGA
      INNER JOIN T0641ITENTREGA I ON I.T0641IDCARGA = R.T065IDCARGA
      INNER JOIN T622EDROTATRANSF G ON G.T622ID = R.T065IDTRANSGRUPO
      INNER JOIN T623EDROTAITEM P ON P.T623IDPLATAFORMA = G.T622ID AND P.T623IDPEDIDOITEM = I.T0641IDITVENDA
      INNER JOIN T620EDROTA E ON E.T620ID = G.T622IDROTA
      WHERE I.T0641IDVENDA = :NUMPEDIDO)
   UNION ALL
   SELECT
         DISTINCT
         'Transferência' TIPOCORTE,
         TRA.T075IDTRANSF IDPEDIDO,
         TRA.T075IDTRANSF IDORIGEM,
         TRA.T075GRUPOTRANSROTA IDREMESSA
   FROM T075TRANSFLOJA TRA
   INNER JOIN T076ITTRANSF ITT ON ITT.T076IDTRANSF = TRA.T075IDTRANSF
   INNER JOIN T050PRODUTOS PRO ON PRO.T050IDPROD = ITT.T076PRODUTO
   WHERE TRA.T075GRUPOTRANSROTA IN ( SELECT
      P.T623IDREMESSA IDREMESSA
      FROM T064CARGA C
      INNER JOIN T065ROTAS R ON R.T065IDCARGA = C.T064IDCARGA
      INNER JOIN T0641ITENTREGA I ON I.T0641IDCARGA = R.T065IDCARGA
      INNER JOIN T622EDROTATRANSF G ON G.T622ID = R.T065IDTRANSGRUPO
      INNER JOIN T623EDROTAITEM P ON P.T623IDPLATAFORMA = G.T622ID AND P.T623IDPEDIDOITEM = I.T0641IDITVENDA
      INNER JOIN T620EDROTA E ON E.T620ID = G.T622IDROTA
      WHERE I.T0641IDVENDA = :NUMPEDIDO)
      AND ITT.T076STATUS = 'C'
   UNION ALL
   SELECT
         DISTINCT
         'Transferência' TIPOCORTE,
         ITV.T081IDVENDA IDPEDIDO,
         ITV.T081IDVENDA IDORIGEM,
         TRA.T075GRUPOTRANSROTA IDREMESSA
   FROM T075TRANSFLOJA TRA
   INNER JOIN T0764ITENTREGADIRETA ETT ON ETT.T0764IDTRANSF = TRA.T075IDTRANSF
   INNER JOIN T231DEMANDAMERC DEM ON DEM.T231IDDEMANDA = ETT.T0764IDDEMANDA
   INNER JOIN T081ITENVENDA ITV ON ITV.T081IDITVENDA = DEM.T231ID81
   INNER JOIN T050PRODUTOS PRO ON PRO.T050IDPROD = ITV.T081PRODUTO
   WHERE TRA.T075GRUPOTRANSROTA IN (
   SELECT
      P.T623IDREMESSA IDREMESSA
      FROM T064CARGA C
      INNER JOIN T065ROTAS R ON R.T065IDCARGA = C.T064IDCARGA
      INNER JOIN T0641ITENTREGA I ON I.T0641IDCARGA = R.T065IDCARGA
      INNER JOIN T622EDROTATRANSF G ON G.T622ID = R.T065IDTRANSGRUPO
      INNER JOIN T623EDROTAITEM P ON P.T623IDPLATAFORMA = G.T622ID AND P.T623IDPEDIDOITEM = I.T0641IDITVENDA
      INNER JOIN T620EDROTA E ON E.T620ID = G.T622IDROTA
      WHERE I.T0641IDVENDA = :NUMPEDIDO)  AND ETT.T0764STATUS = 'C'
)
SELECT
      MOV.T320IDVENDA CODIGO
FROM T320MOVVENDA MOV
LEFT JOIN T614ECOMVENDAS ECO ON ECO.T614IDVENDA = MOV.T320IDVENDA
LEFT JOIN CORTES ON (CORTES.IDPEDIDO = MOV.T320IDVENDA )
WHERE MOV.T320IDVENDA = :NUMPEDIDO
AND CORTES.IDPEDIDO IS NULL
AND MOV.T320PRODUTO = :PRODUTO
AND MOV.T320ESTOQUE = 0
AND MOV.T320SITAUTOENT IN ('X','W','B','S','R','F','D')



























SELECT
    DISTINCT
--    DM.T231IDDEMANDA,
--    DM.T231LOJA,
    DM.T231CODPROD,
--    DM.T231QUANT,
    DM.T231CHAVE,
    DM.T231ID81,
--    MV.T320TIPOMOV,
--    MV.T320SITAUTOENT,
    MV.T320QUANT,
    MV.T320ESTOQUE,
    MV.T320DATA,
    MV.T320QTDENT,
    MV.T320QTDPEND--,
--    S.T053SALDO,
--    S.T053TERCEIROS
FROM T231DEMANDAMERC DM
 INNER JOIN T320MOVVENDA MV ON MV.T320IDITEM = DM.T231ID81 AND MV.T320ESTOQUE = DM.T231LOJA
 INNER JOIN T0500PARAMVALOR PV ON PV.T0500IDPROD = DM.T231CODPROD AND PV.T0500NOMEPAR = 'SEMPREVCOMPRA'
 INNER JOIN T053SALDOS S ON S.T053PRODUTO = DM.T231CODPROD AND S.T053UNIDADE = DM.T231LOJA
 WHERE DM.T231STATUS = 0
 AND COALESCE(PV.T0500VALOR,'N') = 'S'
-- AND MV.T320TIPOMOV IN (9,25)
-- AND MV.T320SITAUTOENT IN ('F','R', 'D')
-- AND MV.T320QTDPEND <> 0
-- AND DM.T231CODPROD = 76002
   AND ((MV.T320TIPOMOV = 9 AND MV.T320SITAUTOENT = 'F') OR
      (MV.T320TIPOMOV = 25 AND MV.T320ESTOQUE = 0 AND MV.T320SITAUTOENT  in ('R','A')) OR
      (MV.T320TIPOMOV = 26 AND MV.T320ESTOQUE <> 0 AND MV.T320SITAUTOENT = 'F') /*OR
      (MV.T320TIPOMOV = 33 AND MV.T320ESTOQUE = 901 AND MV.T320SITAUTOENT = 'F')*/)
   AND (MV.T320QUANT = MV.T320QTDENT)
-- and DM.T231CHAVE = 430092057
-- AND DM.T231LOJA = 1


----SELECT * FROM T053SALDOS S WHERE S.t053saldo < 0 --S.T053UNIDADE IN (0,49) AND S.T053PRODUTO = 75635
--select * from t081itenvenda iv where iv.t081idvenda in (43030, 43087, 43062,43013)
--SELECT * FROM T231DEMANDAMERC DM WHERE DM.T231CHAVE IN (43030, 43087, 43062, 43013)
--SELECT * FROM T320MOVVENDA MV WHERE MV.T320IDVENDA IN (30130286)-- MV.T320PRODUTO = 75810





SELECT
    DM.T231IDDEMANDA as DEMANDA,
    COALESCE(V.T080LOJA,DM.T231LOJA) AS LOJA,
    U.T021DESC AS NOMELOJA,
    DM.T231CODPROD AS CODPROD,
    P.T050DESCRICAO AS NOMEPRODUTO,
    P.T050ATIVO AS ATIVO,
    DM.T231QUANT AS QTDE,
    DM.T231TIPO AS TIPO,
    CASE DM.T231TIPO
        WHEN 'V' THEN 'Venda'
        WHEN 'E' THEN 'Estorno'
        WHEN 'T' THEN 'Transferência'
        WHEN 'R' THEN 'Estoque Regulador'
    END AS DESTINO,
    DM.T231CHAVE AS IDORIGEM,
    DM.T231ID81 AS IDITEMVENDA,
    DM.T231DATARECEB AS DATARECEB,
    DM.T231BLOQREQ AS BLOQUEADO,
    IIF(DM.T231LOJA = 901,DM.T231DATAENTREGA,IV.T081ENTREGAREM) AS DTENTREGA,
    DM.T231DATARESERVA AS DTRESERVA,
    CAST(FLEPARAMETRO('SEMPREVCOMPRA',DM.T231CODPROD,'N','PRODUT') AS CHAR(1)) AS SEMPREVISAO,
    COALESCE(IV.T081ESTOQUE, DM.T231LOJA) AS CODENTREGA,
    UE.T021DESC AS UNENTREGA,
    (P.T050AREAM3 * DM.T231QUANT) AS VOLUME,
    CASE RT.T622STATUS
        when 'PE' then 'Pendente Gestor'
        when 'CA' then 'Cancelado'
        when 'ER' then 'Enviado Roteirizador'
        when 'VR' then 'Validando Roteirizador'
        when 'RR' then 'Recebendo Roteirizador'
        when 'FR' then 'Finalizado Roteirizador'
        when 'EW' then 'Enviado WMS'
        when 'FW' then 'Finalizado WMS'
        when 'OV' then 'Ordem de Venda Enviada'
        when 'RQ' THEN 'Requisições de Transf Enviada'
        when 'RO' THEN 'Rota e Carga Enviada'
        when 'FT' then 'Itens Faturados'
        when 'RB' then 'Retornado Benner'
        when 'FG' then 'Finalizado Gestor'
    END AS STATUSROTA,
    DM.T231STATUS AS STATUSDEMANDA,
    (E.T016LOGRADOURO||', '||E.T016NUMERO) AS ENDERECO,
    E.T016BAIRRO AS BAIRRO,
    CID.T023NOME AS CIDADE,
    E.T016CEP AS CEP,
    V.T080CLIENTE AS DOCUMENTO,
    RT.T622ID AS IDROTA,
    TL.T075IDTRANSF AS IDTRANSF,
    RT.T622DATAROTA AS DTROTA,
    DM.T231OBSERVACAO AS OBSERVACAO,
    E.T016LATITUDE AS LATITUDE,
    E.T016LONGITUDE AS LONGITUDE,
    MOS.T2312IDITVENDA ITEMMOST,
    V.T080IDTRANSP AS CODSERVTRANSPORTADORA,
    PT.T025NOME AS NOMETRANSPORTADORA
 FROM T231DEMANDAMERC DM
 INNER JOIN T050PRODUTOS P ON P.T050IDPROD = DM.T231CODPROD
 LEFT JOIN T081ITENVENDA IV ON IV.T081IDITVENDA = DM.T231ID81
 LEFT JOIN T021UNIDADES UE ON UE.T021CODUND = COALESCE(IV.T081ESTOQUE,DM.T231LOJA)
 LEFT JOIN T016ENDERECO E ON E.T016IDENDE = COALESCE(IV.T081IDENDENTREGA, UE.T021ENDERECO)
 LEFT JOIN T023CIDADES CID ON CID.T023IDCID = E.T016IDCID
 LEFT JOIN T080VENDA V ON V.T080IDVENDA = IV.T081IDVENDA
 LEFT JOIN T021UNIDADES U ON U.T021CODUND = COALESCE(V.T080LOJA, DM.T231LOJA)
 LEFT JOIN T075TRANSFLOJA TL ON TL.T075IDTRANSF = DM.T231LOTE
 LEFT JOIN T622EDROTATRANSF RT ON RT.T622ID = TL.T075GRUPOTRANSROTA
 LEFT JOIN T614ECOMVENDAS EV ON EV.T614IDVENDA = V.T080IDVENDA
 LEFT JOIN T2312MOSTRUARIOCOMSALDO MOS ON MOS.T2312IDITVENDA = DM.T231ID81
 LEFT JOIN T631ECOMTRANSPORTADORES ET ON ET.T631ID = V.T080IDTRANSP
 LEFT JOIN T025PESSOAS PT ON PT.T025IDPESSOA = ET.T631IDFORNECEDOR
 WHERE 
    (CASE :STATUS
        WHEN 0 THEN (DM.T231STATUS = 0)
        WHEN 1 THEN (DM.T231STATUS = 2)
        WHEN 2 THEN (DM.T231STATUS IN(0, 2))
    END)
   AND ((DM.T231CODPROD = :IDPRODUTO) OR (:IDPRODUTO IS NULL))
   AND ((DM.T231LOJA    = :IDLOJA) OR (:IDLOJA IS NULL))
   AND ((DM.T231CHAVE   = :IDVENDA) OR (:IDVENDA IS NULL))
   AND ((E.T016IDCID    = :IDCIDADE) OR (:IDCIDADE IS NULL))
   AND ((IIF(DM.T231LOJA= 901,DM.T231DATAENTREGA,IV.T081ENTREGAREM) BETWEEN :DTINICIO AND :DTFINAL) OR
      (:DTINICIO IS NULL AND :DTFINAL IS NULL))
   AND ((EV.T614NUMPEDIDO = :IDPEDIDO) OR (:IDPEDIDO IS NULL))
   AND
   CASE WHEN COALESCE(:EXIBEMOSTRUARIO, 'N') = 'S'
   THEN MOS.T2312IDVENDA IS NOT NULL AND MOS.T2312INTEGRADOROTEIRIZADOR = 'N'
   ELSE
       1=1
   END
   ORDER BY DM.T231DATARECEB, DM.T231CHAVE


